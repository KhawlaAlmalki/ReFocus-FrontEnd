###
# ReFocus Profile Management API Tests
# Use with REST Client extension in VS Code
# Base URL: http://localhost:5050
###

@baseUrl = http://localhost:5050
@contentType = application/json

### Variables (will be set from responses)
@authToken =

###############################################################################
# SETUP: LOGIN TO GET AUTH TOKEN
###############################################################################

### Step 1: Login with verified user to get token
# @name loginSuccess
POST {{baseUrl}}/api/auth/login
Content-Type: {{contentType}}

{
  "email": "alice@example.com",
  "password": "Alice@12345"
}

### Extract token from login response
@authToken = {{loginSuccess.response.body.token}}

###############################################################################
# 1. GET PROFILE
###############################################################################

### Get current user profile (with valid token) - Success
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}

### Get profile without token (Should fail with 403)
GET {{baseUrl}}/api/users/profile

### Get profile with invalid token (Should fail with 401)
GET {{baseUrl}}/api/users/profile
Authorization: Bearer invalid-token-here

###############################################################################
# 2. UPDATE PROFILE - NAME
###############################################################################

### Update profile name (Success)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Alice Updated"
}

### Update profile with invalid name - too short (Should fail)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "A"
}

### Update profile with empty name (Should fail)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": ""
}

###############################################################################
# 3. UPDATE PROFILE - EMAIL
###############################################################################

### Update profile email (Success - should require re-verification)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "email": "alice.new@example.com"
}

### Update profile with invalid email format (Should fail)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "email": "not-an-email"
}

### Update profile with existing email (Should fail with 409)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "email": "testuser@example.com"
}

###############################################################################
# 4. UPDATE PROFILE - PROFILE PICTURE URL
###############################################################################

### Update profile picture with valid URL (Success)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "profilePicture": "https://example.com/avatar.jpg"
}

### Update profile picture with invalid URL (Should fail)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "profilePicture": "not-a-url"
}

### Remove profile picture by setting to null (Success)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "profilePicture": null
}

###############################################################################
# 5. UPDATE PROFILE - MULTIPLE FIELDS
###############################################################################

### Update multiple fields at once (Success)
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Alice Johnson",
  "profilePicture": "https://example.com/new-avatar.jpg"
}

### Update profile without token (Should fail with 403)
PUT {{baseUrl}}/api/users/profile
Content-Type: {{contentType}}

{
  "name": "Should Fail"
}

###############################################################################
# 6. CHANGE PASSWORD
###############################################################################

### Change password (Success)
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "NewPassword@123",
  "confirmPassword": "NewPassword@123"
}

### Change password back to original
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "NewPassword@123",
  "newPassword": "Alice@12345",
  "confirmPassword": "Alice@12345"
}

### Change password with wrong current password (Should fail with 401)
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "WrongPassword123",
  "newPassword": "NewPassword@123",
  "confirmPassword": "NewPassword@123"
}

### Change password with mismatched confirmation (Should fail with 400)
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "NewPassword@123",
  "confirmPassword": "DifferentPassword@123"
}

### Change password with weak new password (Should fail with 400)
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "weak",
  "confirmPassword": "weak"
}

### Change password with same as current (Should fail with 400)
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "Alice@12345",
  "confirmPassword": "Alice@12345"
}

### Change password without token (Should fail with 403)
PUT {{baseUrl}}/api/users/change-password
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "NewPassword@123",
  "confirmPassword": "NewPassword@123"
}

### Change password with missing fields (Should fail with 400)
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "NewPassword@123"
}

###############################################################################
# 7. UPLOAD PROFILE PICTURE (FILE)
###############################################################################

### Upload profile picture (Success)
# Note: Replace the file path with an actual image file on your system
# POST {{baseUrl}}/api/users/profile/picture
# Authorization: Bearer {{authToken}}
# Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
#
# ------WebKitFormBoundary7MA4YWxkTrZu0gW
# Content-Disposition: form-data; name="profilePicture"; filename="profile.jpg"
# Content-Type: image/jpeg
#
# < C:/path/to/your/image.jpg
# ------WebKitFormBoundary7MA4YWxkTrZu0gW--

### Upload profile picture without token (Should fail with 403)
# POST {{baseUrl}}/api/users/profile/picture
# Content-Type: multipart/form-data
#
# (file data)

### Upload profile picture with invalid file type (Should fail with 400)
# Note: Try uploading a .txt or .pdf file
# Should reject non-image files

### Upload profile picture exceeding size limit (Should fail with 400)
# Note: Try uploading a file larger than 5MB
# Should reject files over the size limit

###############################################################################
# 8. DELETE PROFILE PICTURE
###############################################################################

### Delete profile picture (Success)
DELETE {{baseUrl}}/api/users/profile/picture
Authorization: Bearer {{authToken}}

### Delete profile picture without token (Should fail with 403)
DELETE {{baseUrl}}/api/users/profile/picture

### Delete profile picture when none exists (Should fail with 400)
# First delete the picture, then try deleting again
DELETE {{baseUrl}}/api/users/profile/picture
Authorization: Bearer {{authToken}}

###############################################################################
# 9. COMPLETE PROFILE UPDATE FLOW
###############################################################################

### Step 1: Get current profile
# @name getCurrentProfile
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}

### Step 2: Update profile with all fields
PUT {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Alice Complete Update",
  "profilePicture": "https://example.com/complete-avatar.jpg"
}

### Step 3: Verify profile was updated
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{authToken}}

### Step 4: Change password
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "Alice@12345",
  "newPassword": "CompleteTest@123",
  "confirmPassword": "CompleteTest@123"
}

### Step 5: Login with new password to verify change
# @name loginNewPassword
POST {{baseUrl}}/api/auth/login
Content-Type: {{contentType}}

{
  "email": "alice@example.com",
  "password": "CompleteTest@123"
}

### Step 6: Change password back to original
@newAuthToken = {{loginNewPassword.response.body.token}}
PUT {{baseUrl}}/api/users/change-password
Authorization: Bearer {{newAuthToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "CompleteTest@123",
  "newPassword": "Alice@12345",
  "confirmPassword": "Alice@12345"
}

###############################################################################
# END OF TESTS
###############################################################################
